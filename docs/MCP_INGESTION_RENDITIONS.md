# MCP Ingestion: Renditions & Streaming - Spec

Purpose
-------
Define the ingestion-time responsibilities and metadata schema so the MCP layer can reliably produce, pin, and expose web-optimized video renditions (for low-latency playback) while keeping IPFS CIDs as the canonical references.

Goals
-----
- Ensure every uploaded video has zero or more web-optimized renditions (360p/480p/720p) with pinned CIDs.
- Validate that pinned CIDs resolve with appropriate streaming headers (Content-Type, Accept-Ranges, CORS).
- Store `metadata.renditions` in the asset record for client selection and MCP auditing.
- Provide optional streaming URL (CDN/HLS) when available.

Metadata schema (example)
-------------------------
Add `renditions` under `metadata` for each asset. Example (JSON):

```json
"metadata": {
  "duration": 254.87,
  "dimensions": "1280x720",
  "isrc": "ZA-80H-25-00001",
  "renditions": [
    { "cid": "QmAbcd360", "width": 426, "height": 240, "bitrate": 600000, "label": "360p" },
    { "cid": "QmAbcd480", "width": 854, "height": 480, "bitrate": 1200000, "label": "480p" },
    { "cid": "QmUtJ6hHq6N...", "width": 1280, "height": 720, "bitrate": 3000000, "label": "720p" }
  ],
  "streaming": { "hlsCid": "QmHlsIndex...", "cdnUrl": "https://cdn.example.com/videos/abc/master.m3u8" }
}
```

Ingestion workflow (recommended)
--------------------------------
1. Receive upload (original fileCid). Store a temporary asset record.
2. Transcode asynchronously into desired renditions (360p/480p/720p) and generate poster thumbnails.
3. Pin each rendition to your pinning provider or IPFS node and collect resulting CIDs.
4. Validate each rendition CID by running header checks (see `scripts/mcp_cid_check.sh`) to ensure:
   - `Content-Type` is appropriate (e.g., `video/mp4` or `application/vnd.apple.mpegurl` for HLS)
   - `Accept-Ranges: bytes` (for range requests support) — optional for HLS
   - `Access-Control-Allow-Origin: *` (or your origin) for cross-origin playback
5. Update the asset metadata with `metadata.renditions` and optionally `metadata.streaming`.
6. Mark asset as ready and surface the preferred rendition or streaming URL via the MCP API.
7. If validation fails for a rendition, re-queue pin/transcode, or mark the rendition as "unavailable" in metadata and surface a warning.

Validation & Health checks
--------------------------
- Use the provided `scripts/mcp_cid_check.sh` (bash) to validate CIDs during ingestion.
- Fail fast: if the master rendition lacks `Accept-Ranges` or CORS, flag for operator review.

Client integration notes
------------------------
- Clients may receive `metadata.renditions` and should pick a rendition based on viewport width and/or network conditions.
- Fallback: if `renditions` is empty, clients should use `fileCid` (original) as the source; ensure it is pinned and validated as above.

Security & access
-----------------
- Private/internal assets: if access control is required, do not expose CDN URLs publicly; instead serve signed URLs or a proxied endpoint that enforces permissions.
- Keep `recovery` and `debug` tools gated behind admin-only routes.

Operational suggestions
------------------------
- Keep a periodic job that re-validates pinned CIDs (headers + response code) and alerts if any fail.
- Maintain a remediation queue for failed pins (retry with exponential backoff).
- Consider generating HLS for best playback experience; store HLS master index as `streaming.hlsCid` and optionally serve via CDN.

Appendix: curl checks (examples)
--------------------------------
Replace `<gateway>` and `<cid>` as needed.

HEAD:

```bash
curl -I -L "https://gateway.pinata.cloud/ipfs/<cid>"
```

Range probe (expect 206 and Accept-Ranges header):

```bash
curl -I -L -H "Range: bytes=0-1" "https://gateway.pinata.cloud/ipfs/<cid>"
```

Check response contains `Content-Type: video/mp4`, `Accept-Ranges: bytes`, and `Access-Control-Allow-Origin`.

---
Generated by: MCP ingestion spec v1.0 — keep in docs and sync with MCP agent code.
